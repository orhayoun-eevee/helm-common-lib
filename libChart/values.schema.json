{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "libChart Values Schema",
  "description": "JSON Schema validation for helm-common-lib libChart values",
  "type": "object",
  "required": ["global"],
  "additionalProperties": true,

  "properties": {
    "global": {
      "title": "Global Configuration",
      "type": "object",
      "description": "Global configuration for all resources",
      "required": ["name", "namespace"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "title": "Application Name",
          "type": "string",
          "description": "Application name (DNS-1123 compliant, max 63 chars)",
          "minLength": 1,
          "maxLength": 63,
          "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
        },
        "namespace": {
          "title": "Namespace",
          "type": "string",
          "description": "Kubernetes namespace for all resources",
          "minLength": 1,
          "maxLength": 63,
          "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
        },
        "chart": {
          "type": "object",
          "properties": {
            "appVersion": {
              "type": "string",
              "description": "Application version"
            }
          }
        },
        "labels": {
          "type": "object",
          "properties": {
            "partOf": {
              "type": "string",
              "description": "Higher-level application name (app.kubernetes.io/part-of)"
            },
            "component": {
              "type": "string",
              "description": "Component type (app.kubernetes.io/component)"
            },
            "overrides": {
              "type": "object",
              "description": "Custom label overrides",
              "additionalProperties": {
                "type": "string"
              }
            }
          }
        }
      }
    },

    "deployment": {
      "title": "Deployment",
      "type": "object",
      "description": "Deployment configuration",
      "properties": {
        "replicas": {
          "type": "integer",
          "description": "Number of pod replicas",
          "minimum": 0,
          "default": 1
        },
        "strategy": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["Recreate", "RollingUpdate"],
              "default": "Recreate"
            }
          }
        },
        "revisionHistoryLimit": {
          "type": "integer",
          "description": "Number of old ReplicaSets to retain",
          "minimum": 0,
          "default": 3
        },
        "imagePullSecrets": {
          "type": "array",
          "description": "Image pull secrets",
          "items": {
            "type": "object",
            "required": ["name"],
            "properties": {
              "name": { "type": "string" }
            }
          }
        },
        "terminationGracePeriodSeconds": {
          "type": "integer",
          "description": "Pod termination grace period",
          "minimum": 0,
          "default": 30
        },
        "dnsPolicy": {
          "type": "string",
          "enum": ["ClusterFirst", "ClusterFirstWithHostNet", "Default", "None"],
          "default": "ClusterFirst"
        },
        "enableServiceLinks": {
          "type": "boolean",
          "description": "Enable service environment variables"
        },
        "automountServiceAccountToken": {
          "type": "boolean",
          "description": "Automount service account token"
        },
        "podLabels": {
          "type": "object",
          "description": "Additional pod labels",
          "additionalProperties": { "type": "string" }
        },
        "podSecurityContext": {
          "type": "object",
          "description": "Pod-level security context"
        },
        "defaultContainerSecurityContext": {
          "type": "object",
          "description": "Default security context for all containers"
        },
        "nodeSelector": {
          "type": "object",
          "description": "Node selector",
          "additionalProperties": { "type": "string" }
        },
        "containers": {
          "type": "object",
          "description": "Container definitions (at least one required for deployment to be created)",
          "patternProperties": {
            "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
              "type": "object",
              "required": ["enabled", "image"],
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "description": "Enable this container"
                },
                "image": {
                  "type": "object",
                  "required": ["repository", "tag"],
                  "properties": {
                    "repository": {
                      "type": "string",
                      "description": "Container image repository",
                      "minLength": 1
                    },
                    "tag": {
                      "type": "string",
                      "description": "Image tag (may include @digest)",
                      "minLength": 1
                    },
                    "pullPolicy": {
                      "type": "string",
                      "enum": ["Always", "IfNotPresent", "Never"],
                      "default": "IfNotPresent"
                    }
                  }
                },
                "command": {
                  "type": "array",
                  "description": "Container command",
                  "items": { "type": "string" }
                },
                "args": {
                  "type": "array",
                  "description": "Container arguments",
                  "items": { "type": "string" }
                },
                "env": {
                  "type": "array",
                  "description": "Environment variables"
                },
                "envFrom": {
                  "type": "array",
                  "description": "Environment variables from ConfigMap/Secret"
                },
                "ports": {
                  "type": "array",
                  "description": "Container ports",
                  "items": {
                    "type": "object",
                    "required": ["name", "containerPort"],
                    "properties": {
                      "name": {
                        "type": "string",
                        "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
                        "maxLength": 15
                      },
                      "containerPort": {
                        "type": "integer",
                        "minimum": 1,
                        "maximum": 65535
                      },
                      "protocol": {
                        "type": "string",
                        "enum": ["TCP", "UDP", "SCTP"],
                        "default": "TCP"
                      }
                    }
                  }
                },
                "volumeMounts": {
                  "type": "array",
                  "description": "Volume mounts"
                },
                "resources": {
                  "type": "object",
                  "description": "Resource requests and limits"
                },
                "livenessProbe": {
                  "type": "object",
                  "description": "Liveness probe configuration"
                },
                "readinessProbe": {
                  "type": "object",
                  "description": "Readiness probe configuration"
                },
                "startupProbe": {
                  "type": "object",
                  "description": "Startup probe configuration"
                },
                "lifecycle": {
                  "type": "object",
                  "description": "Lifecycle hooks"
                },
                "securityContext": {
                  "type": "object",
                  "description": "Container security context"
                }
              }
            }
          }
        },
        "initContainers": {
          "type": "object",
          "description": "Init container definitions",
          "patternProperties": {
            "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
              "type": "object",
              "required": ["image"],
              "properties": {
                "image": {
                  "type": "object",
                  "required": ["repository", "tag"]
                }
              }
            }
          }
        }
      }
    },

    "persistence": {
      "title": "Persistence",
      "type": "object",
      "description": "Persistence configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable persistence (PVCs and volumes)"
        },
        "claims": {
          "type": "object",
          "description": "PersistentVolumeClaim definitions",
          "patternProperties": {
            "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
              "type": "object",
              "required": ["size", "storageClass"],
              "properties": {
                "size": {
                  "type": "string",
                  "description": "Storage size (e.g., 1Gi, 10Gi, 100Mi)",
                  "pattern": "^[0-9]+(Ei|Pi|Ti|Gi|Mi|Ki|E|P|T|G|M|K)$"
                },
                "storageClass": {
                  "type": "string",
                  "description": "Storage class name",
                  "minLength": 1
                },
                "accessMode": {
                  "type": "string",
                  "enum": ["ReadWriteOnce", "ReadOnlyMany", "ReadWriteMany", "ReadWriteOncePod"],
                  "default": "ReadWriteOnce"
                },
                "retain": {
                  "type": "boolean",
                  "default": true,
                  "description": "Retain PVC after helm uninstall (adds helm.sh/resource-policy: keep)"
                }
              }
            }
          }
        },
        "volumes": {
          "type": "array",
          "description": "Volume definitions (nfs, hostPath, emptyDir, etc.)"
        }
      }
    },

    "metrics": {
      "title": "Metrics and Observability",
      "type": "object",
      "description": "Observability configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable metrics collection"
        },
        "serviceMonitor": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Enable ServiceMonitor (requires Prometheus Operator)"
            },
            "port": {
              "type": "integer",
              "description": "Metrics port",
              "minimum": 1,
              "maximum": 65535
            },
            "interval": {
              "type": "string",
              "description": "Scrape interval (e.g., 10s, 1m)",
              "pattern": "^[0-9]+(ms|s|m|h)$"
            },
            "scrapeTimeout": {
              "type": "string",
              "description": "Scrape timeout (e.g., 5s, 30s)",
              "pattern": "^[0-9]+(ms|s|m|h)$"
            },
            "path": {
              "type": "string",
              "description": "Metrics endpoint path"
            },
            "honorLabels": {
              "type": "boolean",
              "default": false
            },
            "selector": {
              "type": "object",
              "description": "Service selector"
            },
            "namespaceSelector": {
              "type": "object",
              "description": "Namespace selector"
            },
            "relabelings": {
              "type": "array",
              "description": "Prometheus relabel configs"
            },
            "metricRelabelings": {
              "type": "array",
              "description": "Prometheus metric relabel configs"
            }
          }
        },
        "prometheusRule": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Enable PrometheusRule (alerting rules)"
            },
            "rules": {
              "type": "array",
              "description": "Prometheus alert rules"
            }
          }
        },
        "grafana": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false,
              "description": "Enable Grafana dashboard"
            },
            "instanceSelector": {
              "type": "object",
              "description": "Grafana instance selector"
            },
            "dashboard": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                },
                "items": {
                  "type": "object",
                  "description": "Dashboard definitions",
                  "patternProperties": {
                    "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
                      "type": "object",
                      "properties": {
                        "enabled": {
                          "type": "boolean",
                          "default": true
                        },
                        "name": {
                          "type": "string",
                          "description": "Dashboard name"
                        },
                        "json": {
                          "description": "Inline JSON dashboard content (string or object)"
                        },
                        "file": {
                          "type": "string",
                          "description": "Dashboard file path"
                        },
                        "allowCrossNamespaceImport": {
                          "type": "boolean",
                          "default": false
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },

    "serviceAccount": {
      "title": "Service Account",
      "type": "object",
      "description": "Service account configuration",
      "properties": {
        "create": {
          "type": "boolean",
          "default": true,
          "description": "Create service account"
        },
        "name": {
          "type": "string",
          "description": "Service account name (defaults to chart name)"
        },
        "automount": {
          "type": "boolean",
          "default": false,
          "description": "Automount service account token"
        },
        "annotations": {
          "type": "object",
          "description": "Service account annotations",
          "additionalProperties": { "type": "string" }
        }
      }
    },

    "secrets": {
      "title": "Secrets",
      "type": "object",
      "description": "Secrets management",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "sealedSecret": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false,
              "description": "Enable SealedSecret generation"
            },
            "items": {
              "type": "object",
              "description": "SealedSecret definitions",
              "patternProperties": {
                "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
                  "type": "object",
                  "required": ["data"],
                  "properties": {
                    "data": {
                      "type": "object",
                      "description": "Sealed secret data",
                      "minProperties": 1
                    },
                    "type": {
                      "type": "string",
                      "default": "Opaque",
                      "enum": ["Opaque", "kubernetes.io/tls", "kubernetes.io/dockerconfigjson", "kubernetes.io/basic-auth", "kubernetes.io/ssh-auth", "kubernetes.io/service-account-token"]
                    }
                  }
                }
              }
            }
          }
        }
      }
    },

    "podDisruptionBudget": {
      "title": "Pod Disruption Budget",
      "type": "object",
      "description": "Pod disruption budget configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "minAvailable": {
          "oneOf": [
            { "type": "integer", "minimum": 0 },
            { "type": "string", "pattern": "^[0-9]+%$" },
            { "type": "null" }
          ],
          "description": "Minimum available pods (mutually exclusive with maxUnavailable)"
        },
        "maxUnavailable": {
          "oneOf": [
            { "type": "integer", "minimum": 0 },
            { "type": "string", "pattern": "^[0-9]+%$" },
            { "type": "null" }
          ],
          "description": "Maximum unavailable pods (mutually exclusive with minAvailable)"
        },
        "unhealthyPodEvictionPolicy": {
          "oneOf": [
            { "type": "string", "enum": ["IfHealthyBudget", "AlwaysAllow"] },
            { "type": "null" }
          ],
          "description": "Unhealthy pod eviction policy (K8s 1.26+)"
        }
      }
    },

    "network": {
      "title": "Network",
      "type": "object",
      "description": "Networking configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "services": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true
            },
            "items": {
              "type": "object",
              "description": "Service definitions",
              "patternProperties": {
                "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
                  "type": "object",
                  "required": ["enabled", "type", "ports"],
                  "properties": {
                    "enabled": {
                      "type": "boolean"
                    },
                    "type": {
                      "type": "string",
                      "enum": ["ClusterIP", "NodePort", "LoadBalancer", "ExternalName"],
                      "default": "ClusterIP"
                    },
                    "ports": {
                      "type": "object",
                      "description": "Service ports",
                      "minProperties": 1,
                      "patternProperties": {
                        "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
                          "type": "object",
                          "required": ["port"],
                          "properties": {
                            "port": {
                              "type": "integer",
                              "minimum": 1,
                              "maximum": 65535
                            },
                            "targetPort": {
                              "oneOf": [
                                { "type": "integer", "minimum": 1, "maximum": 65535 },
                                { "type": "string" }
                              ]
                            },
                            "protocol": {
                              "type": "string",
                              "enum": ["TCP", "UDP", "SCTP"],
                              "default": "TCP"
                            }
                          }
                        }
                      }
                    },
                    "annotations": {
                      "type": "object",
                      "additionalProperties": { "type": "string" }
                    }
                  }
                }
              }
            }
          }
        },
        "httpRoute": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "host": {
              "type": "string",
              "description": "Hostname for HTTPRoute"
            },
            "port": {
              "type": "integer",
              "description": "Service port",
              "minimum": 1,
              "maximum": 65535
            },
            "gateway": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Gateway name (required when httpRoute.enabled is true)"
                },
                "namespace": {
                  "type": "string",
                  "description": "Gateway namespace (required when httpRoute.enabled is true)"
                }
              }
            },
            "routes": {
              "type": "array",
              "description": "HTTPRoute rules"
            }
          },
          "if": {
            "properties": {
              "enabled": { "const": true }
            }
          },
          "then": {
            "required": ["host", "port", "gateway"]
          }
        },
        "networkPolicy": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "items": {
              "type": "object",
              "description": "NetworkPolicy definitions",
              "patternProperties": {
                "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
                  "type": "object",
                  "required": ["enabled", "policyTypes"],
                  "properties": {
                    "enabled": {
                      "type": "boolean"
                    },
                    "policyTypes": {
                      "type": "array",
                      "items": {
                        "type": "string",
                        "enum": ["Ingress", "Egress"]
                      },
                      "minItems": 1
                    },
                    "ingress": {
                      "type": "array",
                      "description": "Ingress rules"
                    },
                    "egress": {
                      "type": "array",
                      "description": "Egress rules"
                    }
                  }
                }
              }
            }
          }
        },
        "istio": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false,
              "description": "Enable Istio features"
            },
            "authorizationPolicy": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                },
                "items": {
                  "type": "object",
                  "description": "AuthorizationPolicy definitions",
                  "patternProperties": {
                    "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$": {
                      "type": "object",
                      "required": ["enabled", "action"],
                      "properties": {
                        "enabled": {
                          "type": "boolean"
                        },
                        "action": {
                          "type": "string",
                          "enum": ["ALLOW", "DENY", "AUDIT", "CUSTOM"]
                        },
                        "rules": {
                          "type": "array",
                          "description": "Authorization rules"
                        }
                      }
                    }
                  }
                }
              }
            },
            "destinationrule": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                },
                "host": {
                  "type": "string",
                  "description": "Destination service hostname"
                },
                "trafficPolicy": {
                  "type": "object",
                  "description": "Traffic policy (connection pool, circuit breaker)"
                }
              },
              "if": {
                "properties": {
                  "enabled": { "const": true }
                }
              },
              "then": {
                "required": ["host"]
              }
            }
          }
        }
      }
    }
  }
}
