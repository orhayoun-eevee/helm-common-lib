# Unit tests for ServiceMonitor and PrometheusRule (from libChart), run via test-chart render.
# With minimal values: 0=ServiceAccount, 1=Deployment, 2=ServiceMonitor, 3=PrometheusRule
suite: test observability templates
templates:
  - templates/all.yaml
tests:
  - it: should render ServiceMonitor with endpoints and interval
    set:
      global:
        name: sm-app
        namespace: monitor-ns
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: "1.25"
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          port: 9100
          interval: "15s"
          scrapeTimeout: "10s"
          path: "/metrics"
          honorLabels: true
        prometheusRule:
          enabled: true
          rules: []
    asserts:
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: metadata.name
          value: sm-app
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: metadata.namespace
          value: monitor-ns
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: spec.endpoints[0].port
          value: metrics
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: spec.endpoints[0].interval
          value: 15s
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: spec.endpoints[0].scrapeTimeout
          value: 10s
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: spec.endpoints[0].path
          value: /metrics
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: spec.endpoints[0].honorLabels
          value: true

  - it: should render ServiceMonitor with custom portName
    set:
      global:
        name: port-app
        namespace: default
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: "1.25"
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          portName: "http-metrics"
        prometheusRule:
          enabled: true
          rules: []
    asserts:
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: spec.endpoints[0].port
          value: http-metrics

  - it: should render ServiceMonitor with selector
    set:
      global:
        name: selector-app
        namespace: default
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: latest
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          selector:
            matchLabels:
              app.kubernetes.io/name: selector-app
        prometheusRule:
          enabled: true
          rules: []
    asserts:
      - documentSelector:
          path: kind
          value: ServiceMonitor
        equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: selector-app

  - it: should render PrometheusRule with alert rules
    set:
      global:
        name: rule-app
        namespace: rule-ns
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: "1.25"
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
        prometheusRule:
          enabled: true
          rules:
            - alert: ServiceDown
              expr: up == 0
              for: 5m
              labels:
                severity: critical
              annotations:
                summary: "Service is down"
                description: "Service has been down for more than 5 minutes"
    asserts:
      - documentSelector:
          path: kind
          value: PrometheusRule
        equal:
          path: metadata.name
          value: rule-app
      - documentSelector:
          path: kind
          value: PrometheusRule
        equal:
          path: metadata.namespace
          value: rule-ns
      - documentSelector:
          path: kind
          value: PrometheusRule
        equal:
          path: spec.groups[0].name
          value: rule-app.rules
      - documentSelector:
          path: kind
          value: PrometheusRule
        equal:
          path: spec.groups[0].rules[0].alert
          value: ServiceDown
      - documentSelector:
          path: kind
          value: PrometheusRule
        equal:
          path: spec.groups[0].rules[0].expr
          value: up == 0
      - documentSelector:
          path: kind
          value: PrometheusRule
        equal:
          path: spec.groups[0].rules[0].for
          value: 5m
      - documentSelector:
          path: kind
          value: PrometheusRule
        equal:
          path: spec.groups[0].rules[0].labels.severity
          value: critical
      - documentSelector:
          path: kind
          value: PrometheusRule
        equal:
          path: spec.groups[0].rules[0].annotations.summary
          value: "Service is down"
