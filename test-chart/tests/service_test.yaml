# Unit tests for the Service template (from libChart), run via appChart render.
# With minimal values (no PDB): 0=ServiceAccount, 1=Deployment, 2=Service
suite: test service template
templates:
  - templates/all.yaml
tests:
  - it: should render Service with ClusterIP and ports
    set:
      global:
        name: test-app
        namespace: test-namespace
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: "1.25"
      network:
        services:
          items:
            main:
              enabled: true
              type: ClusterIP
              ports:
                http:
                  port: 80
                  targetPort: 8080
                  protocol: TCP
    asserts:
      - documentIndex: 2
        equal:
          path: kind
          value: Service
      - documentIndex: 2
        equal:
          path: metadata.name
          value: test-app-main
      - documentIndex: 2
        equal:
          path: metadata.namespace
          value: test-namespace
      - documentIndex: 2
        equal:
          path: spec.type
          value: ClusterIP
      - documentIndex: 2
        equal:
          path: spec.ports[0].name
          value: http
      - documentIndex: 2
        equal:
          path: spec.ports[0].port
          value: 80
      - documentIndex: 2
        equal:
          path: spec.ports[0].targetPort
          value: 8080

  - it: should render Service with NodePort and annotations
    set:
      global:
        name: svc-app
        namespace: default
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: latest
      network:
        services:
          items:
            main:
              enabled: true
              type: NodePort
              ports:
                http:
                  port: 80
                  targetPort: 8080
                  protocol: TCP
              annotations:
                test.annotation: test-value
    asserts:
      - documentIndex: 2
        equal:
          path: kind
          value: Service
      - documentIndex: 2
        equal:
          path: spec.type
          value: NodePort
      - documentIndex: 2
        equal:
          path: 'metadata.annotations["test.annotation"]'
          value: test-value
