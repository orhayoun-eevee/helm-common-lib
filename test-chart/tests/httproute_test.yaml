# Unit tests for the HTTPRoute template (from libChart), run via test-chart render.
# With minimal values (no PDB, no services): 0=ServiceAccount, 1=Deployment, 2=HTTPRoute
suite: test httproute template
templates:
  - templates/all.yaml
tests:
  - it: should render HTTPRoute with host and gateway
    set:
      global:
        name: test-app
        namespace: test-namespace
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: "1.25"
      network:
        httpRoute:
          enabled: true
          host: test-app.example.com
          port: 80
          gateway:
            name: my-gateway
            namespace: istio-system
          routes:
            - name: route
              enabled: true
              listener:
                sectionName: https
              rules:
                - matches:
                    - path:
                        type: PathPrefix
                        value: /
                  backendRefs:
                    - name: test-app
                      port: 80
                      weight: 100
                      group: ""
                      kind: Service
    asserts:
      - documentSelector:
          path: kind
          value: HTTPRoute
        equal:
          path: metadata.name
          value: test-app-route
      - documentSelector:
          path: kind
          value: HTTPRoute
        equal:
          path: metadata.namespace
          value: test-namespace
      - documentSelector:
          path: kind
          value: HTTPRoute
        equal:
          path: spec.hostnames[0]
          value: test-app.example.com
      - documentSelector:
          path: kind
          value: HTTPRoute
        equal:
          path: spec.parentRefs[0].name
          value: my-gateway
      - documentSelector:
          path: kind
          value: HTTPRoute
        equal:
          path: spec.parentRefs[0].namespace
          value: istio-system
      - documentSelector:
          path: kind
          value: HTTPRoute
        equal:
          path: spec.parentRefs[0].sectionName
          value: https
