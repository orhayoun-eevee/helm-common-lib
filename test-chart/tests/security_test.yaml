# Unit tests for ServiceAccount, NetworkPolicy, and SealedSecret (from libChart), run via appChart render.
# Document order varies by test; each test uses minimal values to fix indices.
suite: test security templates
templates:
  - templates/all.yaml
tests:
  - it: should render ServiceAccount with custom name and automount
    set:
      global:
        name: test-app
        namespace: test-namespace
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: "1.25"
      serviceAccount:
        create: true
        name: custom-sa
        automount: false
    asserts:
      - documentIndex: 0
        equal:
          path: kind
          value: ServiceAccount
      - documentIndex: 0
        equal:
          path: metadata.name
          value: custom-sa
      - documentIndex: 0
        equal:
          path: metadata.namespace
          value: test-namespace
      - documentIndex: 0
        equal:
          path: automountServiceAccountToken
          value: false

  - it: should render ServiceAccount with default name when name not set
    set:
      global:
        name: default-app
        namespace: default
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: latest
      serviceAccount:
        create: true
    asserts:
      - documentIndex: 0
        equal:
          path: kind
          value: ServiceAccount
      - documentIndex: 0
        equal:
          path: metadata.name
          value: default-app

  - it: should render NetworkPolicy with ingress and egress rules
    set:
      global:
        name: np-app
        namespace: np-ns
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: "1.25"
      network:
        services:
          items:
            main:
              enabled: true
              type: ClusterIP
              ports:
                http:
                  port: 80
                  targetPort: 8080
                  protocol: TCP
        networkPolicy:
          items:
            main:
              enabled: true
              policyTypes:
                - Ingress
                - Egress
              ingress:
                - from:
                    - podSelector:
                        matchLabels:
                          app: allowed
                  ports:
                    - protocol: TCP
                      port: 80
              egress:
                - to:
                    - namespaceSelector: {}
                  ports:
                    - protocol: TCP
                      port: 53
    asserts:
      - documentIndex: 3
        equal:
          path: kind
          value: NetworkPolicy
      - documentIndex: 3
        equal:
          path: metadata.name
          value: np-app-main
      - documentIndex: 3
        equal:
          path: spec.policyTypes[0]
          value: Ingress
      - documentIndex: 3
        equal:
          path: spec.policyTypes[1]
          value: Egress
      - documentIndex: 3
        equal:
          path: spec.ingress[0].from[0].podSelector.matchLabels.app
          value: allowed
      - documentIndex: 3
        equal:
          path: spec.ingress[0].ports[0].port
          value: 80
      - documentIndex: 3
        equal:
          path: spec.egress[0].ports[0].port
          value: 53

  - it: should render SealedSecret with encrypted data
    set:
      global:
        name: secret-app
        namespace: secret-ns
      deployment:
        replicas: 1
        containers:
          app:
            enabled: true
            image:
              repository: nginx
              tag: "1.25"
      secrets:
        enabled: true
        sealedSecret:
          enabled: true
          items:
            my-secret:
              data:
                username: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEQAx...
                password: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEQAx...
              annotations:
                sealedsecrets.bitnami.com/managed: "true"
              type: Opaque
    asserts:
      - documentIndex: 2
        equal:
          path: kind
          value: SealedSecret
      - documentIndex: 2
        equal:
          path: metadata.name
          value: my-secret
      - documentIndex: 2
        equal:
          path: metadata.namespace
          value: secret-ns
      - documentIndex: 2
        equal:
          path: spec.encryptedData.username
          value: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEQAx...
      - documentIndex: 2
        equal:
          path: spec.encryptedData.password
          value: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEQAx...
      - documentIndex: 2
        equal:
          path: spec.template.type
          value: Opaque
