# Template validation tests (business logic only).
# Structural checks (types, patterns, conditional-required, minProperties) are enforced by
# values.schema.json and tested via automated schema fail-case tests (make test-schema).
# These tests cover only what schema cannot express:
#   - deployment: at least one enabled container (iteration logic)
#   - PDB: mutual exclusivity with zero-value awareness (index + ne nil)
suite: test validation failures
templates:
  - templates/all.yaml
values:
  - fixtures/valid-base.yaml
tests:
  # ---- Deployment ----
  - it: should fail when no containers are enabled
    values:
      - fixtures/no-enabled-containers.yaml
    asserts:
      - failedTemplate:
          errorMessage: "deployment.containers must have at least one enabled container"

  # ---- PDB ----
  - it: should fail when PDB has both minAvailable and maxUnavailable set
    set:
      podDisruptionBudget.enabled: true
      podDisruptionBudget.minAvailable: 1
      podDisruptionBudget.maxUnavailable: 1
    asserts:
      - failedTemplate:
          errorMessage: "podDisruptionBudget.minAvailable and maxUnavailable are mutually exclusive (set only one)"

  - it: should fail when PDB is enabled but neither minAvailable nor maxUnavailable set
    set:
      podDisruptionBudget.enabled: true
      podDisruptionBudget.minAvailable: null
      podDisruptionBudget.maxUnavailable: null
    asserts:
      - failedTemplate:
          errorMessage: "podDisruptionBudget requires either minAvailable or maxUnavailable when enabled"

  - it: should render when PDB is enabled with only minAvailable set
    set:
      podDisruptionBudget.enabled: true
      podDisruptionBudget.minAvailable: 1
      podDisruptionBudget.maxUnavailable: null
    asserts:
      - hasDocuments:
          count: 3
      - documentIndex: 0
        equal:
          path: kind
          value: ServiceAccount

  - it: should render when PDB is enabled with minAvailable zero
    set:
      podDisruptionBudget.enabled: true
      podDisruptionBudget.minAvailable: 0
      podDisruptionBudget.maxUnavailable: null
    asserts:
      - hasDocuments:
          count: 3

  - it: should render when PDB is enabled with only maxUnavailable set
    set:
      podDisruptionBudget.enabled: true
      podDisruptionBudget.minAvailable: null
      podDisruptionBudget.maxUnavailable: 1
    asserts:
      - hasDocuments:
          count: 3

  - it: should render when PDB is enabled with percentage minAvailable
    set:
      podDisruptionBudget.enabled: true
      podDisruptionBudget.minAvailable: "50%"
      podDisruptionBudget.maxUnavailable: null
    asserts:
      - hasDocuments:
          count: 3

  - it: should render when PDB is disabled (skip validation)
    set:
      podDisruptionBudget.enabled: false
    asserts:
      - hasDocuments:
          count: 2

  # Aggregated multi-error output is validated by scripts/test-validation-aggregation.sh.
  # helm-unittest failedTemplate assertions are exact-match and can be brittle for multiline errors.
