name: PR Validation

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  packages: read

jobs:
  auth:
    name: Create GitHub App Token
    runs-on: ubuntu-latest
    env:
      GH_APP_ID: ${{ secrets.GHCR_AUTO_APP_ID || vars.GHCR_AUTO_APP_ID }}
      GH_APP_PRIVATE_KEY: ${{ secrets.GHCR_AUTO_PKEY }}
    outputs:
      workflow_repo_token: ${{ steps.app-token.outputs.token }}
    steps:
      - name: Validate app credentials presence
        run: |
          if [ -z "${GH_APP_ID}" ]; then
            echo "Missing GHCR_AUTO_APP_ID (set as repository/org secret or variable)" >&2
            exit 1
          fi
          if [ -z "${GH_APP_PRIVATE_KEY}" ]; then
            echo "Missing required secret: GHCR_AUTO_PKEY" >&2
            exit 1
          fi
      - name: Mint app installation token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ env.GH_APP_ID }}
          private-key: ${{ env.GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

  # Validate libChart (library chart)
  # Library charts skip render-dependent layers.
  validate-lib:
    name: Validate libChart
    needs: auth
    uses: orhayoun-eevee/build-workflow/.github/workflows/helm-validate.yaml@main
    with:
      chart_path: libChart
      kubernetes_version: "1.30.0"
      run_syntax: true
      run_schema: false
      run_metadata: true
      run_tests: false
      run_policy: false
      run_version_check: true
    secrets:
      workflow_repo_token: ${{ needs.auth.outputs.workflow_repo_token }}

  # Validate test-chart (test harness for libChart)
  # Full validation: syntax, schema, metadata, tests, policy
  validate-test:
    name: Validate test-chart
    needs:
      - auth
      - validate-lib
    uses: orhayoun-eevee/build-workflow/.github/workflows/helm-validate.yaml@main
    with:
      chart_path: test-chart
      kubernetes_version: "1.30.0"
      scenarios_dir: tests/scenarios
      snapshots_dir: tests/snapshots
      run_syntax: true
      run_schema: true
      run_metadata: false       # Version check handled by validate-lib
      run_tests: true
      run_policy: true
      target_branch: main
      run_version_check: false  # test-chart version follows libChart
    secrets:
      workflow_repo_token: ${{ needs.auth.outputs.workflow_repo_token }}
