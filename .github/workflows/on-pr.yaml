name: PR Validation

on:
  pull_request:
    branches:
      - main

jobs:
  # Validate libChart (library chart)
  # Library charts can only run syntax/metadata checks (no rendered manifests)
  validate-lib:
    name: Validate libChart
    uses: orhayoun-eevee/build-workflow/.github/workflows/helm-validate.yaml@main
    with:
      chart_path: libChart
      kubernetes_version: "1.30.0"
      run_lint: true
      run_schema: false         # Library charts don't render manifests
      run_metadata: true
      run_tests: false          # Library charts don't have unit tests directly
      run_policy: false         # No rendered manifests to scan
      run_version_check: true
    secrets: inherit

  # Validate test-chart (test harness for libChart)
  # Full validation: syntax, schema, metadata, tests, policy
  validate-test:
    name: Validate test-chart
    uses: orhayoun-eevee/build-workflow/.github/workflows/helm-validate.yaml@main
    with:
      chart_path: test-chart
      kubernetes_version: "1.30.0"
      scenarios_dir: tests/scenarios
      snapshots_dir: tests/snapshots
      target_branch: main
      run_lint: true
      run_schema: true
      run_metadata: false       # Version check handled by validate-lib
      run_tests: true
      run_policy: true
      run_version_check: false  # test-chart version follows libChart
    secrets: inherit
    needs: validate-lib
