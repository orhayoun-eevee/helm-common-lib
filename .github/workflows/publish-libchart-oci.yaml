name: Publish Charts to GHCR OCI

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: Azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Extract tag version
        id: tag_version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix if present
          TAG_VERSION=${TAG_VERSION#v}
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $TAG_VERSION"

      - name: Extract chart version
        id: chart_version
        run: |
          CHART_VERSION=$(grep '^version:' libChart/Chart.yaml | awk '{print $2}')
          echo "chart_version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $CHART_VERSION"

      - name: Verify version match
        run: |
          if [ "${{ steps.tag_version.outputs.tag_version }}" != "${{ steps.chart_version.outputs.chart_version }}" ]; then
            echo "Error: Tag version (${{ steps.tag_version.outputs.tag_version }}) does not match chart version (${{ steps.chart_version.outputs.chart_version }})"
            echo "Please ensure the git tag matches the version in libChart/Chart.yaml"
            exit 1
          fi
          echo "Version match verified: ${{ steps.chart_version.outputs.chart_version }}"

      - name: Lint libChart
        run: |
          helm lint ./libChart

      - name: Update appChart dependencies
        run: |
          cd appChart
          # This uses the local file:// dependency to test the current source code
          helm dependency update

      - name: Lint appChart
        run: |
          helm lint ./appChart

      - name: Install kubeconform
        env:
          KUBECONFORM_VERSION: v0.6.4
          # SHA256 for v0.6.4 linux-amd64
          KUBECONFORM_SHA256: "2b4ebeaa4d5ac4843cf8f7b7e66a8874252b6b71bc7cbfc4ef1cbf85acec7c07"
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz
          echo "${KUBECONFORM_SHA256}  kubeconform-linux-amd64.tar.gz" | sha256sum -c -
          tar -xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v

      - name: Validate manifests with kubeconform
        run: |
          set -o pipefail
          cd appChart
          helm template test-release . -f ../tests/values.test.yaml | \
            kubeconform -strict -skip ServiceMonitor,PrometheusRule,HTTPRoute,AuthorizationPolicy,DestinationRule || {
              echo "kubeconform validation failed"
              exit 1
            }
          echo "kubeconform validation passed"

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            -u ${{ github.actor }} \
            --password-stdin

      - name: Package chart
        run: |
          mkdir -p dist
          helm package ./libChart --destination ./dist
          echo "Chart packaged: $(ls -1 ./dist/)"

      - name: Push lib-chart to GHCR OCI
        run: |
          # Extract chart name from Chart.yaml (now lowercase for OCI compliance)
          CHART_NAME=$(grep '^name:' libChart/Chart.yaml | awk '{print $2}')
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          # Use dynamic chart name to find the packaged file
          CHART_FILE=$(ls -1 ./dist/$CHART_NAME-*.tgz)
          
          # OCI path format: oci://ghcr.io/<owner>/<chart-name>
          # Chart name is now lowercase, so it matches OCI requirements
          helm push "$CHART_FILE" oci://ghcr.io/$OWNER_LOWER/$CHART_NAME
          echo "Published: oci://ghcr.io/$OWNER_LOWER/$CHART_NAME:${{ steps.chart_version.outputs.chart_version }}"

      - name: Sync app-chart version and update dependency
        run: |
          CHART_VERSION="${{ steps.chart_version.outputs.chart_version }}"
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          LIB_CHART_NAME=$(grep '^name:' libChart/Chart.yaml | awk '{print $2}')
          
          # Update app-chart version to match lib-chart version (lockstep)
          sed -i "s/^version:.*/version: $CHART_VERSION/" appChart/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$CHART_VERSION\"/" appChart/Chart.yaml
          
          # Update dependency to use OCI repository with strict version
          sed -i "s|repository: file://../libChart|repository: oci://ghcr.io/$OWNER_LOWER/$LIB_CHART_NAME|" appChart/Chart.yaml
          sed -i "s/version: 0.0.1/version: $CHART_VERSION/" appChart/Chart.yaml
          
          # Remove the commented OCI line if it exists
          sed -i '/# To use the published OCI chart:/d' appChart/Chart.yaml
          sed -i '/# repository: oci:/d' appChart/Chart.yaml
          
          echo "Updated app-chart version to $CHART_VERSION"
          echo "Updated dependency to OCI: oci://ghcr.io/$OWNER_LOWER/$LIB_CHART_NAME"

      - name: Update app-chart dependencies
        run: |
          cd appChart
          helm dependency update

      - name: Lint app-chart (with OCI dependency)
        run: |
          helm lint ./appChart

      - name: Package app-chart
        run: |
          APP_CHART_NAME=$(grep '^name:' appChart/Chart.yaml | awk '{print $2}')
          helm package ./appChart --destination ./dist
          echo "Chart packaged: $(ls -1 ./dist/$APP_CHART_NAME-*.tgz)"

      - name: Push app-chart to GHCR OCI
        run: |
          APP_CHART_NAME=$(grep '^name:' appChart/Chart.yaml | awk '{print $2}')
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          CHART_VERSION="${{ steps.chart_version.outputs.chart_version }}"
          
          # Use dynamic chart name to find the packaged file
          CHART_FILE=$(ls -1 ./dist/$APP_CHART_NAME-*.tgz)
          
          # OCI path format: oci://ghcr.io/<owner>/<chart-name>
          helm push "$CHART_FILE" oci://ghcr.io/$OWNER_LOWER/$APP_CHART_NAME
          echo "Published: oci://ghcr.io/$OWNER_LOWER/$APP_CHART_NAME:$CHART_VERSION"
