name: Publish libChart to GHCR OCI

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: Azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Extract tag version
        id: tag_version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix if present
          TAG_VERSION=${TAG_VERSION#v}
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $TAG_VERSION"

      - name: Extract chart version
        id: chart_version
        run: |
          CHART_VERSION=$(grep '^version:' libChart/Chart.yaml | awk '{print $2}')
          echo "chart_version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $CHART_VERSION"

      - name: Verify version match
        run: |
          if [ "${{ steps.tag_version.outputs.tag_version }}" != "${{ steps.chart_version.outputs.chart_version }}" ]; then
            echo "Error: Tag version (${{ steps.tag_version.outputs.tag_version }}) does not match chart version (${{ steps.chart_version.outputs.chart_version }})"
            echo "Please ensure the git tag matches the version in libChart/Chart.yaml"
            exit 1
          fi
          echo "Version match verified: ${{ steps.chart_version.outputs.chart_version }}"

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            -u ${{ github.actor }} \
            --password-stdin

      - name: Package chart
        run: |
          mkdir -p dist
          helm package ./libChart --destination ./dist
          echo "Chart packaged: $(ls -1 ./dist/)"

      - name: Push lib-chart to GHCR OCI
        run: |
          # Extract chart name from Chart.yaml (now lowercase for OCI compliance)
          CHART_NAME=$(grep '^name:' libChart/Chart.yaml | awk '{print $2}')
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          # Use dynamic chart name to find the packaged file
          CHART_FILE=$(ls -1 ./dist/$CHART_NAME-*.tgz)
          
          # OCI path format: oci://ghcr.io/<owner>/<chart-name>
          # Chart name is now lowercase, so it matches OCI requirements
          helm push "$CHART_FILE" oci://ghcr.io/$OWNER_LOWER/$CHART_NAME
          echo "Published: oci://ghcr.io/$OWNER_LOWER/$CHART_NAME:${{ steps.chart_version.outputs.chart_version }}"
