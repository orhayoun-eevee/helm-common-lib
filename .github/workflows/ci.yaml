name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  unit-test:
    name: Unit tests (helm-unittest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: Azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Install helm-unittest plugin
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest --version v0.4.2 || true

      - name: Update appChart dependencies
        run: |
          helm dependency update appChart

      - name: Run helm unittest
        run: |
          helm unittest appChart

  lint-and-validate:
    name: Lint and validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: Azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Install chart-testing (ct)
        run: |
          curl -LO https://github.com/helm/chart-testing/releases/download/v3.11.0/chart-testing_3.11.0_linux_amd64.tar.gz
          tar -xzf chart-testing_3.11.0_linux_amd64.tar.gz
          sudo mv ct /usr/local/bin/
          ct version

      - name: Fetch chart-testing config (Chart.yaml schema for ct lint)
        run: |
          mkdir -p .ct
          curl -sSL -o .ct/chart_schema.yaml \
            https://raw.githubusercontent.com/helm/chart-testing/main/etc/chart_schema.yaml

      - name: Update chart dependencies (for ct lint)
        run: |
          helm dependency update appChart

      - name: Run ct lint
        run: |
          ct lint --config ct.yaml --all

      - name: Install kubeconform
        env:
          KUBECONFORM_VERSION: v0.6.4
          KUBECONFORM_SHA256: "2b4ebeaa4d5ac4843cf8f7b7e66a8874252b6b71bc7cbfc4ef1cbf85acec7c07"
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz
          echo "${KUBECONFORM_SHA256}  kubeconform-linux-amd64.tar.gz" | sha256sum -c -
          tar -xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v

      - name: Run validation script (lint, template, kubeconform, golden)
        run: |
          chmod +x scripts/validate.sh
          ./scripts/validate.sh
